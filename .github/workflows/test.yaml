name: CI
on: [push, workflow_dispatch]

jobs:
  demo:
    strategy:
      fail-fast: false
      matrix:
        runs: [ubuntu-latest] #[ubuntu-ml-gpu, ubuntu-ci-64cpu]
    runs-on: ${{ matrix.runs }}
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python 3.8
      uses: actions/setup-python@v2
      with:
        python-version: 3.8
    - name: test
      run: | 
        pip install tensorflow wandb numpy
        python train.py
      env:
        WANDB_API_KEY: ${{ secrets.WANDB_API_KEY }}
        WANDB_ENTITY: ${{ secrets.WANDB_ENTITY }}
        WANDB_PROJECT: ${{ secrets.WANDB_PROJECT }}
  
    - name: Get Runs Using SHA
      uses: machine-learning-apps/wandb-action@master
      with:
        PROJECT_NAME: ${{ format('{0}/{1}', secrets.WANDB_ENTITY, secrets.WANDB_PROJECT) }}
        FILTER_GITHUB_SHA: ${{ env.GITHUB_SHA }}
        BASELINE_TAGS: "['baseline', 'reference']"
        DISPLAY_METRICS: "['loss', 'acc', 'val_loss', 'val_acc', '_runtime']"
        WANDB_API_KEY: ${{ secrets.WANDB_API_KEY }}
        DEBUG: 'true'

    - name: See metrics
      run: cat wandb_report.csv